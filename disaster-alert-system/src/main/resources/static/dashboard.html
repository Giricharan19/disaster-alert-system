<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>Disaster Management Dashboard</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    :root {
      --bg1: #0f2027;
      --bg2: #203a43;
      --bg3: #2c5364;
      --card: #0f151a;
      --input: #162026;
      --accent: #20e38a;
      --accent-dark: #0fb063;
      --white: #e9f7f1;
    }

    * {
      box-sizing: border-box;
      font-family: Inter, Arial;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--bg1), var(--bg2), var(--bg3));
      color: var(--white);
    }

    .hidden {
      display: none;
    }

    header {
      padding: 16px 22px;
      display: flex;
      justify-content: space-between;
      background: rgba(0, 0, 0, 0.45);
    }

    section {
      margin: 22px;
      background: #0f151a;
      padding: 22px;
      border-radius: 16px;
    }

    input,
    select,
    button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border-radius: 12px;
      border: none;
    }

    input,
    select {
      background: var(--input);
      color: var(--white);
    }

    button {
      background: linear-gradient(180deg, var(--accent), var(--accent-dark));
      font-weight: 700;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.5;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    th,
    td {
      padding: 12px;
      border-bottom: 1px solid #333;
    }

    .mapBox {
      height: 350px;
      border-radius: 12px;
      margin: 15px 0;
    }
    .card {
  background: linear-gradient(145deg, #101820, #0c1419);
  padding: 16px;
  border-radius: 14px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.4);
  }

    /* ===== ADMIN TABLE ENHANCEMENTS ===== */
    #adminTable tr {
      transition: background 0.25s ease, transform 0.2s ease;
    }

    #adminTable tr:hover {
      background: rgba(32, 227, 138, 0.08);
      transform: scale(1.005);
    }

    #adminTabs {
      display: flex;
      gap: 14px;
      padding: 16px 22px;
    }

    #adminTabs button {
      width: auto;
      padding: 10px 18px;
    }

    .assign-select {
      background: #162026;
      color: #e9f7f1;
      border-radius: 20px;
      padding: 6px 14px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      cursor: pointer;
    }

    .assign-select:hover {
      background: rgba(32, 227, 138, 0.15);
      border-color: #20e38a;
    }
  </style>
</head>

<body>

  <header>
    <h3 id="roleTitle"></h3>
    <button onclick="logout()">Logout</button>
  </header>

  <!-- ================= CITIZEN ================= -->
  <section id="citizenSection" class="hidden">
    <h3>üö® Report Disaster</h3>

    <input id="cType" placeholder="Disaster Type" />

    <select id="cSeverity">
      <option>Low</option>
      <option>Moderate</option>
      <option>High</option>
    </select>

    <div id="citizenMap" class="mapBox"></div>

    <input id="lat" placeholder="Latitude" readonly />
    <input id="lng" placeholder="Longitude" readonly />
    <input id="location" placeholder="Location" readonly />

    <button onclick="confirmLocation()">Confirm Location</button>
    <button id="sendBtn" onclick="submitDisaster()" disabled>
      Send Alert
    </button>
  </section>

  <!-- ================= CITIZEN ALERT ================= -->
  <section id="citizenAlertSection" class="hidden">
    <h3>üîî Send Alert to Admin</h3>
    <iframe
      src="alert.html"
      style="width:100%; height:500px; border:none; border-radius:12px;">
    </iframe>
  </section>

  <!-- ================= RESPONDER ================= -->
  <section id="responderSection" class="hidden">
    <h3>üßØ Responder View</h3>

    <div id="responderMap" class="mapBox"></div>

    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Severity</th>
          <th>Location</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="responderTable"></tbody>
    </table>
  </section>

  <section id="responderAlertsSection" class="hidden">
    <h3>üîî Assigned Alerts</h3>

    <table>
      <thead>
        <tr>
          <th>Message</th>
          <th>Location</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="responderAlertsTable"></tbody>
    </table>
  </section>

  <!-- ================= ADMIN TABS ================= -->
  <div id="adminTabs" class="hidden">
    <button onclick="showAdminSection('dashboard')">Dashboard</button>
    <button onclick="showAdminSection('alerts')">Alerts</button>
    <button onclick="showAdminSection('reports')">Reports</button>
    <button onclick="showAdminSection('profile')">Profile</button>
  </div>

  <!-- ================= ADMIN DASHBOARD ================= -->
  <section id="adminSection" class="hidden">
    <h3>üõ∞Ô∏è Admin Control Center</h3>

    <div id="adminMap" class="mapBox"></div>

    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Severity</th>
          <th>Status</th>
          <th>Location</th>
          <th>Assign</th>
        </tr>
      </thead>
      <tbody id="adminTable"></tbody>
    </table>
  </section>

  <!-- ================= ADMIN ALERTS ================= -->
  <section id="adminAlertsSection" class="hidden">
    <h3>üîî Citizen Alerts</h3>

    <table>
      <thead>
        <tr>
          <th>Message</th>
          <th>Location</th>
          <th>Status</th>
          <th>Assign</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody id="adminAlertsTable"></tbody>
    </table>
  </section>

  <!-- ================= ADMIN REPORTS ================= -->
  <section id="adminReportsSection" class="hidden">
  <h3>üìä Reports & Analytics</h3>

  <!-- KPI CARDS -->
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:20px">
    <div class="card">Total Disasters<br><b id="rDisTotal">0</b></div>
    <div class="card">Total Alerts<br><b id="rAlertTotal">0</b></div>
    <div class="card">High Risk Areas<br><b id="rRiskCount">0</b></div>
    <div class="card">Engagement<br><b id="rEngage">0</b>%</div>
  </div>

  <!-- CHARTS -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
    <div class="card">
      <h4>Disaster Severity</h4>
      <canvas id="disasterChart"></canvas>
    </div>
    <div class="card">
      <h4>Alert Severity</h4>
      <canvas id="alertChart"></canvas>
    </div>
  </div>

  <!-- HIGH RISK AREAS -->
  <div class="card" style="margin-top:20px">
    <h4>üö® High Risk Areas</h4>
    <ul id="riskList"></ul>
  </div>
  <!-- ===== EXTRA ANALYTICS (DO NOT REMOVE EXISTING) ===== -->
  <h3 style="margin-top:40px;">üìà Advanced Analytics</h3>

  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px">

    <div class="card">
      <h4>üîÑ Alert Lifecycle Status</h4>
      <canvas id="alertStatusDonut"></canvas>
    </div>

    <div class="card">
      <h4>üìä Alert Engagement</h4>
      <canvas id="alertEngagementPie"></canvas>
    </div>

    <div class="card">
      <h4>üö® Alert Status Summary</h4>
      <ul style="list-style:none;padding-left:0">
        <li>üÜï New: <b id="statNew">0</b></li>
        <li>‚úÖ Accepted: <b id="statAccepted">0</b></li>
        <li>üèÅ Completed: <b id="statCompleted">0</b></li>
      </ul>
    </div>

  </div>
</section>

  <!-- ================= ADMIN PROFILE ================= -->
  <section id="adminProfileSection" class="hidden">
    <h3>üë§ Admin Profile</h3>
    <p>Email: <span id="adminEmail"></span></p>
    <p>Role: ADMIN</p>
  </section>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ================= JAVASCRIPT ================= -->
  <script>
    /* ================= GLOBAL ================= */
    let responders = [];
    let citizenMap, citizenMarker;
    let adminMap, responderMap;
    let locationConfirmed = false;

    /* ================= AUTH ================= */
    const user = JSON.parse(localStorage.getItem("loggedUser"));

    if (!user) {
      location.href = "login.html";
    }

    roleTitle.innerText = `${user.role} Dashboard`;

    function logout() {
      localStorage.clear();
      location.href = "login.html";
    }

    /* ================= GEOCODING ================= */
    async function getLocationName(lat, lon) {
      const res = await fetch(
        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`,
        {
          headers: {
            "User-Agent": "DisasterApp/1.0"
          }
        }
      );

      const data = await res.json();
      return data.display_name || "Unknown location";
    }

    /* ================= CITIZEN ================= */
    function initCitizenMap() {
      citizenMap = L.map("citizenMap").setView([20.59, 78.96], 5);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
        .addTo(citizenMap);

      citizenMap.on("click", async (e) => {
        lat.value = e.latlng.lat.toFixed(6);
        lng.value = e.latlng.lng.toFixed(6);

        location.value = "Fetching location...";
        location.value = await getLocationName(
          e.latlng.lat,
          e.latlng.lng
        );

        if (citizenMarker) {
          citizenMap.removeLayer(citizenMarker);
        }

        citizenMarker = L.marker(e.latlng).addTo(citizenMap);

        locationConfirmed = false;
        sendBtn.disabled = true;
      });
    }

    function confirmLocation() {
      if (!lat.value) {
        alert("Select location");
        return;
      }

      locationConfirmed = true;
      sendBtn.disabled = false;
    }

    async function submitDisaster() {
      await fetch("http://localhost:8163/api/disasters/report", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          disasterType: cType.value,
          severity: cSeverity.value,
          latitude: +lat.value,
          longitude: +lng.value,
          location: location.value,
          reportedByRole: "CITIZEN",
          status: "ACTIVE"
        })
      });

      alert("Alert sent to Admin");
    }

    /* ================= LOAD RESPONDERS ================= */
    function loadResponders() {
      fetch("http://localhost:8163/api/alerts/responders")
        .then((r) => r.json())
        .then((d) => {
          responders = d;
          console.log("Responders loaded:", responders);
        });
    }

    /* ================= ADMIN ================= */
    function showAdminSection(type) {
      adminSection.classList.add("hidden");
      adminAlertsSection.classList.add("hidden");
      adminReportsSection.classList.add("hidden");
      adminProfileSection.classList.add("hidden");

      if (type === "dashboard") {
        adminSection.classList.remove("hidden");
        setTimeout(() => adminMap.invalidateSize(), 200);
      }

      if (type === "alerts") {
        adminAlertsSection.classList.remove("hidden");
        loadAdminAlerts();
      }

      if (type === "reports") {
        adminReportsSection.classList.remove("hidden");
        loadReports();
      }

      if (type === "profile") {
        adminProfileSection.classList.remove("hidden");
        adminEmail.innerText = user.email;
      }
    }

    function initAdmin() {
      adminMap = L.map("adminMap").setView([20.59, 78.96], 5);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
        .addTo(adminMap);

      loadResponders();

      setTimeout(() => {
        adminMap.invalidateSize();
        loadAdmin();
      }, 500);

      adminEmail.innerText = user.email;
    }

    function formatStatus(status) {
      if (status === "ACTIVE") return "üÜï New";
      if (status === "IN_PROGRESS") return "‚úÖ Accepted";
      if (status === "RESOLVED") return "üèÅ Completed";
      return status;
    }

    function loadAdmin() {
      adminTable.innerHTML = "";

      adminMap.eachLayer(
        (l) => l instanceof L.Marker && adminMap.removeLayer(l)
      );

      fetch("http://localhost:8163/api/disasters")
        .then((r) => r.json())
        .then((d) => {
          d.forEach((x) => {
            adminTable.innerHTML += `
              <tr>
                <td>${x.disasterType}</td>
                <td>${x.severity}</td>
                <td>${formatStatus(x.status)}</td>
                <td>${x.location || "N/A"}</td>
                <td>
                  <select class="assign-select"
                          onchange="assign(${x.id}, this.value)">
                    <option value="">Assign Responder</option>
                    ${responders.map(
                      (r) =>
                        `<option value="${r.email}">
                          ${r.name} (${r.email})
                        </option>`
                    ).join("")}
                  </select>
                </td>
              </tr>
            `;

            if (x.latitude && x.longitude) {
              L.marker([x.latitude, x.longitude]).addTo(adminMap);
            }
          });
        });
    }

    function loadAdminAlerts() {
      fetch("http://localhost:8163/api/alerts")
        .then((r) => r.json())
        .then((d) => {
          adminAlertsTable.innerHTML = "";

          d.forEach((a) => {
            adminAlertsTable.innerHTML += `
              <tr>
                <td>${a.message}</td>
                <td>${a.location}</td>
                <td>${a.status || "NEW"}</td>
                <td>
                  <select class="assign-select"
                          onchange="assignAlert(${a.id}, this.value)">
                    <option value="">Assign</option>
                    ${responders.map(
                      (r) =>
                        `<option value="${r.email}">
                          ${r.name} (${r.email})
                        </option>`
                    ).join("")}
                  </select>
                </td>
                <td>${new Date(a.sentAt).toLocaleString()}</td>
              </tr>
            `;
          });
        });
    }

    function assign(id, email) {
      if (!email) return;

      fetch(`http://localhost:8163/api/disasters/${id}/assign`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ handledByRole: email })
      }).then(() => loadAdmin());
    }

    function assignAlert(alertId, email) {
      if (!email) return;

      fetch(`http://localhost:8163/api/alerts/${alertId}/assign`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ assignedTo: email })
      }).then(() => loadAdminAlerts());
    }

    /* ================= RESPONDER ================= */
    function initResponder() {
      responderMap = L.map("responderMap").setView([20.59, 78.96], 5);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
        .addTo(responderMap);

      loadResponder();
    }

    function loadResponder() {
      responderTable.innerHTML = "";

      responderMap.eachLayer(
        (l) => l instanceof L.Marker && responderMap.removeLayer(l)
      );

      fetch(`http://localhost:8163/api/disasters/responder/${user.email}`)
        .then((r) => r.json())
        .then((d) => {
          d.forEach((x) => {
            let actionBtn = "";
            let statusLabel = "";

            if (x.status === "ACTIVE") {
              statusLabel = "üÜï New";
              actionBtn = `
                <button onclick="acceptDisaster(${x.id})"
                        style="background:#0fb063;color:white;
                               padding:6px 14px;border-radius:8px">
                  Accept
                </button>`;
            } else if (x.status === "IN_PROGRESS") {
              statusLabel = "‚úÖ Accepted";
              actionBtn = `
                <button onclick="completeDisaster(${x.id})"
                        style="background:#20e38a;color:black;
                               padding:6px 14px;border-radius:8px">
                  Complete
                </button>`;
            } else {
              statusLabel = "üèÅ Completed";
              actionBtn =
                `<span style="color:#20e38a;font-weight:600">Completed</span>`;
            }

            responderTable.innerHTML += `
              <tr>
                <td>${x.disasterType}</td>
                <td>${x.severity}</td>
                <td>${x.location}</td>
                <td>${statusLabel}</td>
                <td>${actionBtn}</td>
              </tr>
            `;

            if (x.latitude && x.longitude) {
              L.marker([x.latitude, x.longitude]).addTo(responderMap);
            }
          });
        });
    }

    function loadResponderAlerts() {
      responderAlertsTable.innerHTML = "";

      fetch(`http://localhost:8163/api/alerts/responder/${user.email}`)
        .then((r) => r.json())
        .then((d) => {
          d.forEach((a) => {
            let action = "";

            if (a.status === "NEW") {
              action = `<button onclick="acceptAlert(${a.id})">Accept</button>`;
            } else if (a.status === "ACCEPTED") {
              action = `<button onclick="completeAlert(${a.id})">Complete</button>`;
            } else {
              action = `<span style="color:#20e38a">Completed</span>`;
            }

            responderAlertsTable.innerHTML += `
              <tr>
                <td>${a.message}</td>
                <td>${a.location}</td>
                <td>${a.status}</td>
                <td>${action}</td>
              </tr>
            `;
          });
        });
    }

    function acceptDisaster(id) {
      fetch(`http://localhost:8163/api/disasters/${id}/accept`, {
        method: "PATCH"
      })
        .then(() => {
          alert("‚úÖ Disaster accepted successfully");
          loadResponder();
        })
        .catch(() => alert("‚ùå Error accepting disaster"));
    }

    function completeDisaster(id) {
      fetch(`http://localhost:8163/api/disasters/${id}/complete`, {
        method: "PATCH"
      }).then(() => {
        alert("‚úÖ Disaster marked as Completed");
        loadResponder();
      });
    }

    function acceptAlert(id) {
      fetch(`http://localhost:8163/api/alerts/${id}/accept`, {
        method: "PATCH"
      }).then(() => loadResponderAlerts());
    }

    function completeAlert(id) {
      fetch(`http://localhost:8163/api/alerts/${id}/complete`, {
        method: "PATCH"
      }).then(() => loadResponderAlerts());
    }
    
    let disasterChartObj, alertChartObj;
    let alertStatusDonutObj, alertEngagementPieObj;


function loadReports() {
  fetch("http://localhost:8163/api/reports/summary")
    .then(r => r.json())
    .then(d => {

      /* ===== KPIs ===== */
      rDisTotal.innerText = d.disasters.total;
      rAlertTotal.innerText = d.alerts.total;
      rRiskCount.innerText = d.highRiskAreas.length;
      rEngage.innerText = d.engagementPercent;

      /* ===== CLEAN OLD CHARTS ===== */
      if (disasterChartObj) disasterChartObj.destroy();
      if (alertChartObj) alertChartObj.destroy();
      if (alertStatusDonutObj) alertStatusDonutObj.destroy();
      if (alertEngagementPieObj) alertEngagementPieObj.destroy();

      /* ===== BAR CHARTS ===== */
      disasterChartObj = new Chart(disasterChart, {
        type: "bar",
        data: {
          labels: ["Low", "Moderate", "High"],
          datasets: [{
            label: "Disasters",
            data: [
              d.disasters.lowSeverity,
              d.disasters.moderateSeverity,
              d.disasters.highSeverity
            ],
            backgroundColor: "#03a9f4"
          }]
        }
      });

      alertChartObj = new Chart(alertChart, {
        type: "bar",
        data: {
          labels: ["Low", "Moderate", "High"],
          datasets: [{
            label: "Alerts",
            data: [
              d.alerts.lowSeverity,
              d.alerts.moderateSeverity,
              d.alerts.highSeverity
            ],
            backgroundColor: "#ff9800"
          }]
        }
      });

      /* ===== HIGH RISK AREAS ===== */
      riskList.innerHTML = "";
      d.highRiskAreas.forEach(r => {
        const li = document.createElement("li");
        li.innerText = `${r[0]} ‚Äî ${r[1]} incidents`;
        riskList.appendChild(li);
      });

      /* ===== STATUS COUNTS ===== */
      statNew.innerText = d.alerts.new;
      statAccepted.innerText = d.alerts.accepted;
      statCompleted.innerText = d.alerts.completed;

      /* ===== DONUT CHART ===== */
      alertStatusDonutObj = new Chart(alertStatusDonut, {
        type: "doughnut",
        data: {
          labels: ["New", "Accepted", "Completed"],
          datasets: [{
            data: [
              d.alerts.new,
              d.alerts.accepted,
              d.alerts.completed
            ],
            backgroundColor: ["#ff9800", "#03a9f4", "#4caf50"]
          }]
        }
      });

      /* ===== PIE CHART ===== */
      alertEngagementPieObj = new Chart(alertEngagementPie, {
        type: "pie",
        data: {
          labels: ["Engaged", "Pending"],
          datasets: [{
            data: [
              d.alerts.accepted,
              d.alerts.total - d.alerts.accepted
            ],
            backgroundColor: ["#20e38a", "#f44336"]
          }]
        }
      });

    });
}

    /* ================= LOAD ROLE ================= */
    window.onload = () => {
      if (user.role !== "ADMIN") {
        adminTabs.style.display = "none";
      }

      if (user.role === "CITIZEN") {
        citizenSection.classList.remove("hidden");
        citizenAlertSection.classList.remove("hidden");
        initCitizenMap();
      }

      if (user.role === "ADMIN") {
        adminTabs.classList.remove("hidden");
        showAdminSection("dashboard");
        initAdmin();
      }

      if (user.role === "RESPONDER") {
        responderSection.classList.remove("hidden");
        responderAlertsSection.classList.remove("hidden");
        initResponder();
        loadResponderAlerts();
      }
    };
  </script>

</body>
</html>
